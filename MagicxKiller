-- // Services
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
local PlaceID = 3623096087

-- // Load Rayfield UI
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- // Create Main Window
local Window = Rayfield:CreateWindow({
	Name = "Magic Killer",
	LoadingTitle = "Magic Killing Script",
	LoadingSubtitle = "by Mark",
	ConfigurationSaving = { Enabled = false }
})

-- // Create Main Tab
local Tab = Window:CreateTab("Main", 4483362458)

-- // Variables
local autoKillEnabled = false
local autoPunchEnabled = false
local autoHopEnabled = false
local visitedServers = {}
local lastCombatTime = 0
local combatCooldown = 5 -- seconds after combat before hopping
local cachedKillScript = nil

-- Task references
local mainTask, autoHopTimerTask
local toolCache = {} -- reuse table for memory efficiency

-- ===== Auto Kill =====
local function runAutoKill()
	if not cachedKillScript then
		local success, response = pcall(function()
			return game:HttpGet("https://raw.githubusercontent.com/seth-pogi/-kill-alllllll/refs/heads/main/Code")
		end)
		if success and response and response ~= "" then
			cachedKillScript = response
		else
			warn("[AutoKill] Failed to load script")
			return
		end
	end

	local ok, err = pcall(function() loadstring(cachedKillScript)() end)
	if ok then
		lastCombatTime = tick()
	else
		warn("[AutoKill] Execution failed:", err)
	end
end

-- ===== Ultra Fast Safe Punch =====
local function runAutoPunch()
	local char = workspace:FindFirstChild(LocalPlayer.Name)
	if not char then return end

	-- Clear previous cache
	for i = 1, #toolCache do toolCache[i] = nil end

	-- Cache punch tools
	for _, tool in ipairs(LocalPlayer.Backpack:GetChildren()) do
		if tool:IsA("Tool") and tool.Name:lower():find("punch") then
			table.insert(toolCache, tool)
		end
	end
	for _, tool in ipairs(char:GetChildren()) do
		if tool:IsA("Tool") and tool.Name:lower():find("punch") then
			table.insert(toolCache, tool)
		end
	end

	-- Activate tools
	for _, punchTool in ipairs(toolCache) do
		if punchTool.Parent ~= char then
			punchTool.Parent = char
			task.wait(0.01)
		end
		local attackTime = punchTool:FindFirstChild("attackTime")
		if attackTime then attackTime.Value = 0.1 end -- ultra fast but safe
		pcall(function() punchTool:Activate() end)
		lastCombatTime = tick()
	end
end

-- ===== Reliable Auto Hop =====
local function runAutoHop()
	local minPlayers, maxPlayers = 17, 20
	local foundServer, cursor = false, nil

	repeat
		local success, serversData = pcall(function()
			local url = "https://games.roblox.com/v1/games/"..PlaceID.."/servers/Public?sortOrder=Asc&limit=100"
			if cursor then url = url.."&cursor="..cursor end
			return HttpService:JSONDecode(game:HttpGet(url))
		end)

		if success and serversData and serversData.data then
			for _, server in ipairs(serversData.data) do
				if server.id ~= game.JobId and
				   server.playing >= minPlayers and server.playing <= maxPlayers and
				   not visitedServers[server.id] then

					visitedServers[server.id] = true
					print("[AutoHop] Hopping to server:", server.id, "Players:", server.playing)
					TeleportService:TeleportToPlaceInstance(PlaceID, server.id, LocalPlayer)
					foundServer = true
					break
				end
			end
			cursor = serversData.nextPageCursor
		else
			task.wait(5) -- retry delay
		end
	until foundServer or not cursor

	if not foundServer then
		task.wait(10) -- retry later if no server
	end
end

-- ===== Combined Main Task =====
local function startMainTask()
	if mainTask then return end
	mainTask = task.spawn(function()
		while autoKillEnabled or autoPunchEnabled or autoHopEnabled do
			if autoKillEnabled then runAutoKill() end
			if autoPunchEnabled then runAutoPunch() end
			if autoHopEnabled and tick() - lastCombatTime > combatCooldown then
				runAutoHop()
			end
			task.wait(0.05) -- safe fast loop
		end
		mainTask = nil
	end)
end

-- ===== Safe 40s Automatic Server Hop =====
local function startAutoHopTimer()
	if autoHopTimerTask then return end
	autoHopTimerTask = task.spawn(function()
		while autoHopEnabled do
			task.wait(40)
			if autoHopEnabled then runAutoHop() end
		end
		autoHopTimerTask = nil
	end)
end

-- ===== GUI Toggles =====
Tab:CreateToggle({
	Name = "Auto Kill",
	CurrentValue = false,
	Callback = function(value)
		autoKillEnabled = value
		startMainTask()
	end
})

Tab:CreateToggle({
	Name = "Ultra Fast Punch (Safe)",
	CurrentValue = false,
	Callback = function(value)
		autoPunchEnabled = value
		startMainTask()
	end
})

Tab:CreateToggle({
	Name = "Auto Hop (17-20 players)",
	CurrentValue = false,
	Callback = function(value)
		autoHopEnabled = value
		startMainTask()
		startAutoHopTimer()
	end
})

Tab:CreateToggle({
	Name = "Start All Features",
	CurrentValue = false,
	Callback = function(value)
		autoKillEnabled 
